<h2 id="overview">Overview</h2>

<p>Upgrading to the latest version of Sunbird allows you to avail benefits of:</p>

<ul>
  <li>Sunbird’s new and enhanced features</li>
  <li>fixes done for bugs raised on the platform</li>
  <li>
    <p>the latest updated versions of any third party component used within Sunbird</p>
  </li>
  <li>
    <p>From release 1.5 onwards:</p>
  </li>
  <li>All the services are maintained with same image gold version</li>
  <li>Cassandra migration is introduced to update cassandra database schema</li>
</ul>

<h2 id="backup-the-databases">Backup the Databases</h2>

<p>1.Run <code>git clone https://github.com/project-sunbird/sunbird-devops</code></p>

<p>2.cd <code>sunbird-devops/deploy/</code></p>

<h3 id="backup-cassandra">Backup Cassandra</h3>

<ol>
  <li>
    <p>Taking the backup</p>

    <pre><code>`./cassandra_backup.py`
</code></pre>
  </li>
</ol>

<p>This step will create a &lt;cassandra_backup-{year}-{month}-{date}&gt; with all data and schema in your working directory.</p>

<h3 id="backup-postgres">Backup Postgres</h3>

<p>To take a backup of the Postgres database:</p>

<p>1.Run the following script to take a full backup of the Postgres database</p>

<pre><code>	./backup_postgres.sh
</code></pre>

<p><strong>Note:</strong> Executing the command creates the backup file at the following location:</p>

<pre><code>	**/tmp/postgresql-backup** 
</code></pre>

<p>2.Postgres Backup includes the following databases:</p>

<p>a) api_manager -	Used by kong
b) badger      -	Used by badger services
c) Keycloak    -	Used by Keycloak
d) quartz      -	Used by sunbird backend services</p>

<h3 id="backup-elastic-search">Backup Elastic Search</h3>

<p>To take a backup of Elastic Search databases:</p>

<p>1.Run the following script to take the backup</p>

<pre><code>  `./backup_elasticsearch.sh`
</code></pre>

<p><strong>Note:</strong> Executing the command creates the backup file at <strong>/etc/elasticsearch/backup</strong></p>

<ol>
  <li>Elasticsearch backup includes the following databases:</li>
</ol>

<p>a) searchindex      - Stores the user, org , course, batch data
b) sunbirdplugin    - Stores the plugin related data (object API)
c) sunbirddataaudit - Stores the user &amp; organization audit history data</p>

<h2 id="restore-databases">Restore Databases</h2>

<h3 id="restore-cassandra">Restore Cassandra</h3>

<ol>
  <li>
    <p>Copy the Cassandra backup to the instance where you want to restore</p>
  </li>
  <li>
    <p>Untar the backup</p>
  </li>
  <li>
    <p>It’ll create directory named cassandra_backup.</p>
  </li>
  <li>
    <p>Run cqlsh -f ‘cassandra_backup/db_schema.cql’. It’ll restore all the schemas.</p>
  </li>
  <li>
    <p>Restore data using the following command:</p>

    <pre><code>`./cassandra_restore.py --host &lt;cassandra_host_ip_address&gt; &lt;snapshotdir&gt;`
</code></pre>

    <p>for example: <code>./cassandra_restore.py --host 10.10.10.10 cassandra_bakup</code></p>
  </li>
</ol>

<h3 id="restore-elastic-search">Restore Elastic Search</h3>

<p>To restore the Elastic Search databases, follow these steps:</p>

<ol>
  <li>
    <p>Copy the backup file from <code>/tmp/elasticsearch-backup/&lt;backup_file&gt;</code> to the instance where you want to run the restore operation.</p>
  </li>
  <li>
    <p>Run the following command:</p>

    <p><code>./restore_elasticsearch.sh &lt;path/to/the/restore_file</code></p>
  </li>
</ol>

<h3 id="restore-postgres">Restore Postgres</h3>

<p>To restore the Postgres database:</p>

<ol>
  <li>
    <p>Copy the backup file from  **/tmp/postgresql-backup/<backup_file>**</backup_file></p>
  </li>
  <li>
    <p>Run the command <code>./restore_postgres.sh</code></p>
  </li>
</ol>

<h2 id="upgrading-sunbird-services">Upgrading Sunbird Services</h2>

<ol>
  <li>
    <p>Pull the latest code of <code>project-sunbird/sunbird-devops</code> from its master branch</p>

    <p><code>git -C sunbird-devops pull || git clone https://github.com/project-sunbird/sunbird-devops</code></p>
  </li>
  <li>
    <p>Run the command <code>cd sunbird-devops/deploy &amp;&amp; ./sunbird-install.sh</code></p>
  </li>
</ol>

<p><strong>Note:</strong></p>

<ul>
  <li>
    <p>Executing the command deploys the latest version of Sunbird services and also updates the latest schema in the databases</p>
  </li>
  <li>
    <p>The latest image versions of all the services are updated in the master branch. To get a hotfix image of any Sunbird service, update the minor version in the <code>sunbird-devops/deploy/deploy-core.sh</code> file and re-run the <code>sunbird-devops/deploy/deploy-core.sh</code> script.</p>
  </li>
</ul>
